using Mimi

@defcomp impacttemperaturestress begin
    regions = Index()
    income = Parameter(index=[time,regions])
    population = Parameter(index=[time,regions])
    gdp90 = Parameter(index=[regions])
    pop90 = Parameter(index=[regions])

    temp90 = Parameter(index=[regions])
    temp=Parameter(index=[time,regions])
    alphamortality = Parameter(index=[regions])
    betaonemortality=Parameter(index=[regions])
    betatwomortality=Parameter(index=[regions])
    cmortality=Parameter(index=[regions])

    function run_timestep(p, v, d, t)

        for r in d.regions
            ypc = 1000.0 * p.income[t, r] / p.population[t, r]
            ypc90 = 1000.0 * p.gdp90[r] / p.pop90[r]

            # 0.49 is the increase in global temperature from pre-industrial to 1990
            TemperatureDifference = p.regtmp[r] - p.temp90[r]

            if TemperatureDifference > 0.0
                tempstressdeadcost[t, r] = p.alphamortality[r]+(p.betaonemortality[r] * (p.temp[t,r]-p.temp90[r])+ p.betatwomortality*(p.temp[t,r]-p.temp90[r])^2)* (ypc^cmortality)
                #tempmortaility is output as percent of gdp
                else
                tempstressdeadcost[t, r] = 0.0
            end
        end
    end
end
